<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>XTerminal — beta 0.6 — Full Build (modified)</title>
<style>
:root{
  --font: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
  --mono-size:11px; --line-height:1.3; --mobile-mono-size:10px;

  /* default (dark) palette */
  --bg:#0a0b0d; --panel:#0e1116cc; --border:#23262d; --rim:#a0b8ff0f; --text:#d8d8d8; --muted:#8a8f98;
  --accent:#7bd4ff; --accent2:#a0b8ff; --danger:#ff4b4b; --ok:#25d48a; --warn:#ffd166; --cmd-color:#7bd4ff; --desc-color:#d8d8d8;
  --progress-bg:#23262d; --progress-fill:#25d48a;
}

/* Light mode (mode A): when html has .light, background/panel/text adjust to light theme.
   Themes will only change accent / accent2 / cmd-color / rim — they won't alter bg/panel in light mode. */
html.light {
  --bg:#ffffff;
  --panel:#ffffff;
  --border:#e6e9ef;
  --rim:#2b5cff10;
  --text:#111827;
  --muted:#4b5563;
  --accent:#2b5cff;
  --accent2:#6aa4ff;
  --danger:#cc2c2c;
  --ok:#1ea66f;
  --warn:#b78200;
  --cmd-color:#2b5cff;
  --desc-color:#4b5563;
  --progress-bg:#e6e9ef;
  --progress-fill:#1ea66f;
}

html.dark {
  /* ensure explicit dark defaults when .dark is set */
  --bg:#0a0b0d;
  --panel:#0e1116cc;
  --border:#23262d;
  --rim:#a0b8ff0f;
  --text:#d8d8d8;
  --muted:#8a8f98;
  --accent:#7bd4ff;
  --accent2:#a0b8ff;
  --danger:#ff4b4b;
  --ok:#25d48a;
  --warn:#ffd166;
  --cmd-color:#7bd4ff;
  --desc-color:#d8d8d8;
  --progress-bg:#23262d;
  --progress-fill:#25d48a;
}

/* Ensure html has a default if neither class applied */
html:not(.light):not(.dark) {
  /* respect user's preferred color scheme by default */
}

/* Common layout */
html,body{height:100%; margin:0; color:var(--text); background:radial-gradient(1200px 600px at 20% -10%, var(--bg) 0%, var(--bg) 60%); font-family:var(--font); font-size:var(--mono-size);}
@media (max-width:768px){html,body{font-size:var(--mobile-mono-size);}}
.wrap{max-width:980px; margin:0 auto; padding:16px}
.header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;padding:10px 12px;border-radius:12px;background:linear-gradient(180deg,color-mix(in oklab,var(--panel)92%,transparent),color-mix(in oklab,var(--panel)80%,transparent));border:1px solid var(--border);backdrop-filter:blur(18px) saturate(1.08);}
.header h1{margin:0;font-weight:600;font-size:13px;color:color-mix(in oklab,var(--text)88%,white)}
.header p{margin:0;font-size:11px;color:var(--muted)}
.terminal{position:relative;border-radius:14px;background:linear-gradient(180deg,color-mix(in oklab,var(--panel)78%,transparent),color-mix(in oklab,var(--panel)66%,transparent));border:1px solid var(--border);box-shadow:0 1px 0 rgba(255,255,255,0.03) inset,0 30px 80px rgba(0,0,0,0.35),0 2px 12px rgba(0,0,0,0.25);backdrop-filter:blur(22px) saturate(1.1);padding:12px;overflow:hidden}
.terminal::before{content:"";position:absolute;inset:0;border-radius:14px;box-shadow:0 0 0 1.5px var(--rim) inset,0 0 60px var(--rim) inset;pointer-events:none}
.screen{height:60vh;overflow:auto;padding:8px;line-height:var(--line-height);scrollbar-width:thin}
.line{white-space:pre-wrap;word-wrap:break-word;margin:1px 0;}
.line .prompt{color:var(--accent)}
.line .cmd{color:var(--cmd-color);font-weight:600}
.line .out{color:var(--text)}
.line .error{color:var(--danger);font-weight:700}
.line .info{color:var(--muted)}
.line .success{color:var(--ok);font-weight:700}
.line .warning{color:var(--warn);font-weight:700}
.line .desc{color:var(--desc-color)}
.line .welcome{color:#2b5cff;font-weight:700} /* fixed blue welcome message */
.typing{display:inline-block;overflow:hidden;border-right:2px solid var(--accent);animation:blink 1s infinite}
@keyframes blink{0%,100%{border-color:transparent}50%{border-color:var(--accent)}}
.input-row{display:flex;gap:8px;margin-top:10px}
.input{flex:1;background:linear-gradient(180deg,color-mix(in oklab,var(--panel)88%,transparent),color-mix(in oklab,var(--panel)70%,transparent));color:var(--text);border:1px solid color-mix(in oklab,var(--border),black 10%);border-radius:10px;padding:9px 10px;outline:none;font-size:12px;box-shadow:0 1px 0 rgba(255,255,255,0.03) inset;transition:border-color .12s,box-shadow .12s,transform .08s;font-family:var(--font);direction:ltr}
.input:focus{border-color:color-mix(in oklab,var(--accent),black 20%);box-shadow:0 0 0 2px color-mix(in oklab,var(--accent2)25%,transparent);transform:translateY(-0.5px)}
.mini{display:flex;gap:6px;margin-top:8px;flex-wrap:wrap}
.chip{font-size:11px;color:color-mix(in oklab,var(--text)80%,white);background:linear-gradient(180deg,color-mix(in oklab,var(--panel)88%,transparent),color-mix(in oklab,var(--panel)72%,transparent));border:1px solid color-mix(in oklab,var(--border),black 10%);padding:6px 8px;border-radius:8px;cursor:pointer}
.footer{margin-top:10px;color:var(--muted);font-size:10px}
.progress-container{margin:8px 0;background:var(--progress-bg);border-radius:8px;overflow:hidden;height:16px;position:relative}
.progress-bar{height:100%;background:linear-gradient(90deg,var(--progress-fill),color-mix(in oklab,var(--progress-fill)80%,white));border-radius:8px;width:0%;transition:width .5s ease;display:flex;align-items:center;justify-content:flex-end;padding-right:8px;color:white;font-size:9px;font-weight:bold;text-shadow:0 0 2px rgba(0,0,0,0.5)}
.progress-text{position:absolute;top:0;left:0;right:0;bottom:0;display:flex;align-items:center;justify-content:center;font-size:9px;color:var(--text);font-weight:bold}
kbd{background:rgba(255,255,255,0.03);padding:2px 6px;border-radius:4px;border:1px solid rgba(255,255,255,0.03);font-size:11px}
.theme-name{cursor:default;padding:4px 6px;border-radius:6px;display:inline-block}
</style>
</head>
<body>
<div class="wrap">
  <div class="header"><h1>XTerminal</h1><p>By L$D</p></div>
  <div class="terminal" role="application" aria-label="XTerminal">
    <div id="screen" class="screen" aria-live="polite"></div>

    <div class="input-row">
      <input id="input" class="input" type="text" placeholder="help" autocomplete="off" spellcheck="false" />
    </div>

    <div class="mini" id="chips" aria-hidden="true"></div>

    <div class="footer">Enter to run • <kbd>↑</kbd>/<kbd>↓</kbd> history • <kbd>Tab</kbd> suggestions</div>
  </div>
</div>

<script>
(() => {
  const screen = document.getElementById('screen');
  const input = document.getElementById('input');
  const chipsEl = document.getElementById('chips');

  // set initial light/dark based on prefers-color-scheme but keep class so theme commands work
  const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
  if(prefersDark) document.documentElement.classList.add('dark');
  else document.documentElement.classList.add('light');

  const availablePackages = {
    system:{name:'System Commands',version:'1.2',commands:['help','clear','theme','info','packages','install','uninstall'],description:'Core system utilities'},
    time:{name:'Time & Date',version:'1.0',commands:['date','time','timer','stopwatch'],description:'Date, time, timer and stopwatch'},
    calculator:{name:'Calculator',version:'1.0',commands:['calc','unit'],description:'Calculator and unit converter'},
    utilities:{name:'Utilities',version:'1.0',commands:['password','uuid','binary','roll'],description:'Handy utilities'},
    text:{name:'Text Utilities',version:'1.0',commands:['echo','alias','notes'],description:'Text tools'},
    settings:{name:'Settings Editor',version:'0.2',commands:['sysedit'],description:'Edit settings'},
    device:{name:'Device Tools',version:'1.0',commands:['device'],description:'Battery and device information'},
    network:{name:'Network Tools',version:'1.0',commands:['ping','ifconfig','netstat','speedtest'],description:'Simulated network utilities (offline)'},
    games:{name:'Games',version:'1.0',commands:['rps','blackjack','slots','mine'],description:'Offline terminal games'},
    themes:{name:'Themes',version:'1.0',commands:['theme-list','theme-set','theme-edit','theme-save','theme-load','theme-reset'],description:'Theme engine and presets'}
  };

  const defaultPackages = { system:true };
  const storedPackages = JSON.parse(localStorage.getItem('xterminal-packages') || 'null');
  const storedSpeed = parseInt(localStorage.getItem('xterminal-typingSpeed') || '15',10);
  const state = {
    history:[], histIdx:-1, timers:new Map(), stopwatchStart:null, aliases:new Map(),
    notes: JSON.parse(localStorage.getItem('xterminal-notes')||'[]'),
    packages: storedPackages || defaultPackages,
    typingSpeed: Math.max(15, isNaN(storedSpeed) ? 15 : storedSpeed)
  };
  if (!state.packages.system) state.packages.system = true;

  /* printing helpers */
  function appendLine(text, cls='out', instant=false){
    const div = document.createElement('div');
    div.className = 'line ' + cls;
    if(instant){
      div.textContent = text;
      screen.appendChild(div);
      screen.scrollTop = screen.scrollHeight;
      return Promise.resolve();
    } else {
      const span = document.createElement('span');
      span.className = 'typing';
      div.appendChild(span);
      screen.appendChild(div);
      screen.scrollTop = screen.scrollHeight;
      return new Promise(resolve => {
        let i = 0;
        const speed = Math.max(1, state.typingSpeed);
        (function step(){
          if(i <= text.length){
            span.textContent = text.substring(0,i);
            i++;
            setTimeout(step, 1000/speed);
          } else {
            span.classList.remove('typing');
            resolve();
          }
        })();
      });
    }
  }
  function printOutput(items=[], instant=false){
    // items: [{t:'out',s:'text'}]
    return items.reduce((p, item) => p.then(()=>{ if(!item || !('s' in item)) return Promise.resolve(); return appendLine(item.s, item.t || 'out', instant); }), Promise.resolve());
  }
  function printPromptLine(cmd){
    const line = document.createElement('div'); line.className = 'line prompt';
    const pspan = document.createElement('span'); pspan.className='prompt'; pspan.textContent='$ ';
    const cspan = document.createElement('span'); cspan.className='cmd'; cspan.textContent = cmd;
    line.appendChild(pspan); line.appendChild(cspan);
    screen.appendChild(line);
    screen.scrollTop = screen.scrollHeight;
  }

  function savePackages(){ localStorage.setItem('xterminal-packages', JSON.stringify(state.packages)); }

  function fmtNumber(n,maxDigits=15){ if(!isFinite(n)) return 'NaN/Infinity'; const s=Number(n).toPrecision(Math.min(maxDigits,15)); const maybe=Number(s); return (Math.abs(maybe)>=1e-6 && Math.abs(maybe)<1e10) ? maybe.toString() : s; }
  function evalExpr(expr){ try{ if(/[^0-9+\-*/%^()., ]/.test(expr)) throw new Error('Invalid'); const fn=new Function('return ('+expr+');'); const res=fn(); if(typeof res!=='number' || !isFinite(res)) throw new Error('Invalid'); return res; }catch(e){ throw new Error('Invalid expression'); } }
  const cityToTZ = { tehran:'Asia/Tehran', mashhad:'Asia/Tehran', shiraz:'Asia/Tehran', dubai:'Asia/Dubai', istanbul:'Europe/Istanbul', riyadh:'Asia/Riyadh', cairo:'Africa/Cairo', berlin:'Europe/Berlin', paris:'Europe/Paris', london:'Europe/London', madrid:'Europe/Madrid', rome:'Europe/Rome', moscow:'Europe/Moscow', tokyo:'Asia/Tokyo', seoul:'Asia/Seoul', beijing:'Asia/Shanghai', singapore:'Asia/Singapore', sydney:'Australia/Sydney', newyork:'America/New_York', losangeles:'America/Los_Angeles', toronto:'America/Toronto', mexico:'America/Mexico_City', sao:'America/Sao_Paulo', delhi:'Asia/Kolkata', karachi:'Asia/Karachi', jakarta:'Asia/Jakarta' };
  function resolveTZ(q){ const k=q.replace(/\s+/g,'').toLowerCase(); return cityToTZ[k]||null; }

  // -----------------------
  // Core commands
  // -----------------------
  async function cmd_help(){ await printOutput([{t:'out',s:'Available commands (installed packages only):'}]); await printOutput([{t:'cmd',s:`system: ${availablePackages.system.commands.join(', ')}`}]); for(const pid of Object.keys(availablePackages)){ if(pid==='system') continue; if(state.packages[pid]) await printOutput([{t:'cmd',s:`${pid}: ${availablePackages[pid].commands.join(', ')}`}]); } await printOutput([{t:'info',s:"Install packages with: install <package>"}]); }

  async function cmd_clear(){ screen.innerHTML=''; await printOutput([{t:'info',s:'Terminal cleared'}], true); }

  async function cmd_theme(args){
    const mode=(args[0]||'').toLowerCase();
    if(mode==='dark'){ document.documentElement.classList.add('dark'); document.documentElement.classList.remove('light'); await printOutput([{t:'success',s:'Theme switched to dark mode'}]); }
    else if(mode==='light'){ document.documentElement.classList.add('light'); document.documentElement.classList.remove('dark'); await printOutput([{t:'success',s:'Theme switched to light mode'}]); }
    else await printOutput([{t:'error',s:'Usage: theme <dark|light>'}]);
  }

  async function cmd_info(){ await printOutput([{t:'out',s:'XTerminal - Beta 0.6'},{t:'out',s:'By XRea1ty (L$D)'}]); }

  async function cmd_packages(){
    // custom rendering so only package NAMES of installed packages are green (only the "name" field)
    for(const [pid,pkg] of Object.entries(availablePackages)){
      const installed = !!state.packages[pid];
      const line = document.createElement('div'); line.className = 'line out';
      const bullet = document.createElement('span'); bullet.textContent = installed ? '● ' : '○ ';
      line.appendChild(bullet);
      const idSpan = document.createElement('span'); idSpan.textContent = pid + ' — ';
      line.appendChild(idSpan);
      const nameSpan = document.createElement('span');
      if(installed) nameSpan.className = 'success';
      nameSpan.textContent = `${pkg.name} v${pkg.version}`;
      line.appendChild(nameSpan);
      screen.appendChild(line);
      const desc = document.createElement('div'); desc.className='line desc'; desc.textContent = `  ${pkg.description}`;
      screen.appendChild(desc);
      const cmds = document.createElement('div'); cmds.className='line desc'; cmds.textContent = `  Commands: ${pkg.commands.join(', ')}`;
      screen.appendChild(cmds);
      const spacer = document.createElement('div'); spacer.className='line out'; spacer.textContent = ' ';
      screen.appendChild(spacer);
    }
    screen.scrollTop = screen.scrollHeight;
  }

  async function cmd_install(args){
    const pkgId=(args[0]||'').toLowerCase();
    if(!pkgId) return printOutput([{t:'error',s:'Usage: install <package>'}]);
    if(!availablePackages[pkgId]) return printOutput([{t:'error',s:`Package '${pkgId}' not found`}]);
    if(state.packages[pkgId]) return printOutput([{t:'warning',s:`Package '${pkgId}' is already installed`}]);

    // installation messages - only final message is green
    await printOutput([{t:'info',s:`Installing ${pkgId}...`}], true);
    const progressContainer=document.createElement('div'); progressContainer.className='progress-container';
    const progressBar=document.createElement('div'); progressBar.className='progress-bar';
    const progressText=document.createElement('div'); progressText.className='progress-text'; progressText.textContent='0%';
    progressContainer.appendChild(progressBar); progressContainer.appendChild(progressText); screen.appendChild(progressContainer); screen.scrollTop=screen.scrollHeight;

    const steps=['Downloading...','Verifying...','Installing files...','Configuring...','Finalizing...'];
    let progress=0; const stepProgress=100/steps.length;
    for(let i=0;i<steps.length;i++){
      await new Promise(resolve=>{
        setTimeout(()=>{
          progress+=stepProgress;
          progressBar.style.width=`${progress}%`;
          progressText.textContent=`${Math.round(progress)}%`;
          // each step printed as info (muted)
          printOutput([{t:'info',s:steps[i]}], true);
          resolve();
        }, 360);
      });
    }

    setTimeout(()=>{
      state.packages[pkgId]=true; savePackages(); progressContainer.remove();
      printOutput([{t:'success',s:`Package '${pkgId}' installed successfully!`}]);
      renderChips();
    }, 400);
  }

  async function cmd_uninstall(args){
    const pkgId=(args[0]||'').toLowerCase();
    if(!pkgId) return printOutput([{t:'error',s:'Usage: uninstall <package>'}]);
    if(!availablePackages[pkgId]) return printOutput([{t:'error',s:`Package '${pkgId}' not found`}]);
    if(!state.packages[pkgId]) return printOutput([{t:'warning',s:`Package '${pkgId}' is not installed`}]);
    if(pkgId==='system') return printOutput([{t:'error',s:'Cannot uninstall system package'}]);

    // uninstall messages - only final message is green
    await printOutput([{t:'info',s:`Uninstalling ${pkgId}...`}], true);
    const progressContainer=document.createElement('div'); progressContainer.className='progress-container';
    const progressBar=document.createElement('div'); progressBar.className='progress-bar';
    const progressText=document.createElement('div'); progressText.className='progress-text'; progressText.textContent='0%';
    progressContainer.appendChild(progressBar); progressContainer.appendChild(progressText); screen.appendChild(progressContainer); screen.scrollTop=screen.scrollHeight;

    let progress=0; const steps=5;
    for(let i=0;i<steps;i++){ await new Promise(resolve=>{ setTimeout(()=>{ progress+=20; progressBar.style.width=`${progress}%`; progressText.textContent=`${progress}%`; resolve(); }, 220); }); }

    setTimeout(()=>{ delete state.packages[pkgId]; savePackages(); progressContainer.remove(); printOutput([{t:'success',s:`Package '${pkgId}' uninstalled.`}]); renderChips(); }, 350);
  }

  // -----------------------
  // Time / Calc / Utilities
  // -----------------------
  async function cmd_date(){
    const now=new Date();
    // build dd-mm-yyyy
    const dd = String(now.getDate()).padStart(2,'0');
    const mm = String(now.getMonth()+1).padStart(2,'0');
    const yyyy = now.getFullYear();
    const weekday = new Intl.DateTimeFormat('en-GB',{weekday:'long'}).format(now);
    const greg = `${weekday}, ${dd}-${mm}-${yyyy}`;
    await printOutput([{t:'out',s:`Gregorian: ${greg}`}]);
  }
  async function cmd_time(args){ const q=args.join(' '); if(!q) return printOutput([{t:'error',s:'Usage: time <city>'}]); const tz=resolveTZ(q); if(!tz) return printOutput([{t:'error',s:'Unknown location'}]); const now=new Date(); const fmt=new Intl.DateTimeFormat('en-GB',{timeZone:tz,hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false}).format(now); await printOutput([{t:'out',s:`${fmt} (${tz})`}]); }
  async function cmd_timer(args){ const seconds=parseInt(args[0],10); if(isNaN(seconds)||seconds<1||seconds>3600) return printOutput([{t:'error',s:'Usage: timer <1-3600>'}]); await printOutput([{t:'out',s:`Timer set for ${seconds}s`}]); const id=`timer_${Date.now()}`; const timeoutId=setTimeout(()=>{ printOutput([{t:'success',s:`Timer finished: ${seconds}s`}]); state.timers.delete(id); }, seconds*1000); state.timers.set(id, timeoutId); }
  async function cmd_stopwatch(args){ const action=(args[0]||'start').toLowerCase(); if(action==='start'){ if(state.stopwatchStart) return printOutput([{t:'error',s:'Stopwatch already running'}]); state.stopwatchStart=Date.now(); await printOutput([{t:'out',s:'Stopwatch started'}]); } else if(action==='stop'){ if(!state.stopwatchStart) return printOutput([{t:'error',s:'Stopwatch not running'}]); const elapsed=Date.now()-state.stopwatchStart; const seconds=Math.floor(elapsed/1000); const minutes=Math.floor(seconds/60); const hours=Math.floor(minutes/60); await printOutput([{t:'out',s:`${hours.toString().padStart(2,'0')}:${(minutes%60).toString().padStart(2,'0')}:${(seconds%60).toString().padStart(2,'0')}`}]); state.stopwatchStart=null; } else if(action==='reset'){ state.stopwatchStart=null; await printOutput([{t:'out',s:'Stopwatch reset'}]); } else await printOutput([{t:'error',s:'Usage: stopwatch <start|stop|reset>'}]); }
  async function cmd_calc(args){ const expr=args.join(' '); if(!expr) return printOutput([{t:'error',s:'Usage: calc <expression>'}]); try{ const val=evalExpr(expr); await printOutput([{t:'out',s:fmtNumber(val)}]); }catch(e){ await printOutput([{t:'error',s:'Error: invalid expression'}]); } }
  async function cmd_unit(args){ if(args.length<3) return printOutput([{t:'error',s:'Usage: unit <value> <from> <to>'}]); const value=parseFloat(args[0]); if(isNaN(value)) return printOutput([{t:'error',s:'Invalid number'}]); const from=args[1].toLowerCase(); const to=args[2].toLowerCase(); const conversions={ 'km-mile':v=>v*0.621371,'mile-km':v=>v*1.60934,'m-ft':v=>v*3.28084,'ft-m':v=>v*0.3048,'kg-pound':v=>v*2.20462,'pound-kg':v=>v*0.453592,'celsius-fahrenheit':v=>(v*9/5)+32,'fahrenheit-celsius':v=>(v-32)*5/9,'liter-gallon':v=>v*0.264172,'gallon-liter':v=>v*3.78541 }; const key=`${from}-${to}`; if(!conversions[key]) return printOutput([{t:'error',s:'Unsupported conversion'}]); const result=conversions[key](value); await printOutput([{t:'out',s:`${value} ${from} = ${result}`}]); }
  async function cmd_password(args){ const length=parseInt(args[0],10)||12; if(length<4||length>50) return printOutput([{t:'error',s:'Length must be between 4-50'}]); const charset='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*'; let pw=''; for(let i=0;i<length;i++) pw+=charset.charAt(Math.floor(Math.random()*charset.length)); await printOutput([{t:'out',s:pw}]); }
  async function cmd_uuid(){ const uuid='xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,function(c){ const r=Math.random()*16|0; const v=c=='x'?r:(r&0x3|0x8); return v.toString(16); }); await printOutput([{t:'out',s:uuid}]); }
  async function cmd_binary(args){ const text=args.join(' '); if(!text) return printOutput([{t:'error',s:'Usage: binary <text>'}]); let binary=''; for(let i=0;i<text.length;i++) binary+=text.charCodeAt(i).toString(2).padStart(8,'0')+' '; await printOutput([{t:'out',s:binary.trim()}]); }
  async function cmd_roll(args){ const dice=args[0]||'1d6'; const m=dice.match(/^(\\d+)d(\\d+)$/); if(!m) return printOutput([{t:'error',s:'Usage: roll NdM (e.g., 2d6)'}]); const count=parseInt(m[1],10), sides=parseInt(m[2],10); if(count<1||count>10) return printOutput([{t:'error',s:'Dice count 1-10'}]); if(sides<2||sides>100) return printOutput([{t:'error',s:'Dice sides 2-100'}]); const rolls=[]; let total=0; for(let i=0;i<count;i++){ const r=Math.floor(Math.random()*sides)+1; rolls.push(r); total+=r; } await printOutput([{t:'out',s:`Rolls: ${rolls.join(', ')}`}]); if(count>1) await printOutput([{t:'out',s:`Total: ${total}`}]); }
  async function cmd_echo(args){ await printOutput([{t:'out',s:args.join(' ')}]); }

  // alias handling
  async function cmd_alias(args){ if(args.length===0){ if(state.aliases.size===0) return printOutput([{t:'info',s:'No aliases defined'}]); state.aliases.forEach((v,k)=>printOutput([{t:'out',s:`${k} -> ${v}`} ])); return; } if(args.length===1){ const name=args[0]; if(state.aliases.has(name)){ state.aliases.delete(name); return printOutput([{t:'success',s:`Alias '${name}' removed`}]); } else return printOutput([{t:'error',s:`Alias '${name}' not found`}]); } const name=args[0]; const cmd=args.slice(1).join(' '); state.aliases.set(name,cmd); await printOutput([{t:'success',s:`Alias set: ${name} -> ${cmd}`}]); }

  // notes
  async function cmd_notes(args){ const action=(args[0]||'list').toLowerCase(); if(action==='list'){ if(state.notes.length===0) return printOutput([{t:'info',s:'No notes saved'}]); for(let i=0;i<state.notes.length;i++) await printOutput([{t:'out',s:`${i+1}. ${state.notes[i]}`}]); } else if(action==='add'){ const note=args.slice(1).join(' '); if(!note) return printOutput([{t:'error',s:'Usage: notes add <text>'}]); state.notes.push(note); localStorage.setItem('xterminal-notes', JSON.stringify(state.notes)); await printOutput([{t:'success',s:'Note added'}]); } else if(action==='rm'||action==='remove'){ const idx=parseInt(args[1],10)-1; if(isNaN(idx)||idx<0||idx>=state.notes.length) return printOutput([{t:'error',s:'Invalid note number'}]); state.notes.splice(idx,1); localStorage.setItem('xterminal-notes', JSON.stringify(state.notes)); await printOutput([{t:'success',s:'Note removed'}]); } else await printOutput([{t:'error',s:'Usage: notes <list|add|rm>'}]); }

  // -----------------------
  // DEVICE package
  // -----------------------
  async function cmd_device(){
    let battInfo = {level:null,charging:null};
    if(navigator.getBattery){
      try{
        const b = await navigator.getBattery();
        battInfo.level = Math.round(b.level*100);
        battInfo.charging = !!b.charging;
      }catch(e){}
    }
    if(battInfo.level===null){
      battInfo.level = Math.floor(Math.random()*60)+20;
      battInfo.charging = Math.random()>0.5;
    }
    const ua = navigator.userAgent || 'Unknown';
    const mem = navigator.deviceMemory || 'unknown';
    const cores = navigator.hardwareConcurrency || 'unknown';
    const screenRes = (window.screen && (window.screen.width || window.screen.height)) ? (window.screen.width+'x'+window.screen.height) : 'unknown';
    await printOutput([
      {t:'out', s:`Battery: ${battInfo.level}% ${battInfo.charging ? '(charging)' : ''}`},
      {t:'out', s:`Device UA: ${ua}`},
      {t:'out', s:`Memory (approx): ${mem} GB`},
      {t:'out', s:`CPU cores (approx): ${cores}`},
      {t:'out', s:`Screen: ${screenRes}`}
    ]);
  }

  // -----------------------
  // NETWORK package (simulated) + warning (English + orange)
  // -----------------------
  function networkWarning(){
    return printOutput([{t:'warning',s:'⚠ This service is offline; results are simulated and not real.'}], true);
  }

  async function cmd_ping(args){
    const target=args[0]||'127.0.0.1';
    await printOutput([{t:'out',s:`PING ${target} (simulated)`},{t:'out',s:`64 bytes from ${target}: icmp_seq=1 ttl=64 time=${(Math.random()*50+1).toFixed(2)} ms`}]);
    await networkWarning();
  }
  async function cmd_ifconfig(){
    await printOutput([
      {t:'out',s:`lo: flags=73<UP,LOOPBACK,RUNNING>  mtu 65536`},
      {t:'out',s:`    inet 127.0.0.1  netmask 255.0.0.0`},
      {t:'out',s:`wlan0: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500`},
      {t:'out',s:`    inet 192.168.1.${Math.floor(Math.random()*50+2)}  netmask 255.255.255.0  broadcast 192.168.1.255`}
    ]);
    await networkWarning();
  }
  async function cmd_netstat(){
    await printOutput([
      {t:'out',s:'Proto Recv-Q Send-Q Local Address           Foreign Address         State'},
      {t:'out',s:`tcp        0      0 192.168.1.${Math.floor(Math.random()*50+2)}:443   93.184.216.34:52314 ESTABLISHED`}
    ]);
    await networkWarning();
  }
  async function cmd_speedtest(){
    const progressContainer=document.createElement('div'); progressContainer.className='progress-container';
    const progressBar=document.createElement('div'); progressBar.className='progress-bar';
    const progressText=document.createElement('div'); progressText.className='progress-text'; progressText.textContent='0%';
    progressContainer.appendChild(progressBar); progressContainer.appendChild(progressText); screen.appendChild(progressContainer); screen.scrollTop=screen.scrollHeight;
    let p=0;
    while(p<100){
      await new Promise(r=>setTimeout(r,200));
      p+=Math.floor(Math.random()*20)+10;
      if(p>100) p=100;
      progressBar.style.width=p+'%';
      progressText.textContent=p+'%';
    }
    setTimeout(async ()=>{
      progressContainer.remove();
      const down=(Math.random()*40+5).toFixed(2);
      const up=(Math.random()*10+1).toFixed(2);
      await printOutput([{t:'out',s:`Download: ${down} Mbps`},{t:'out',s:`Upload: ${up} Mbps`}]);
      await networkWarning();
    }, 300);
  }

  // -----------------------
  // GAMES package (main command removed)
  // -----------------------
  async function cmd_rps(args){
    const you=(args[0]||'').toLowerCase();
    const opts=['rock','paper','scissors'];
    if(!you||!opts.includes(you)) return printOutput([{t:'error',s:'Usage: rps <rock|paper|scissors>'}]);
    const bot=opts[Math.floor(Math.random()*3)];
    let res='Draw';
    if((you==='rock'&&bot==='scissors')||(you==='scissors'&&bot==='paper')||(you==='paper'&&bot==='rock')) res='You win';
    else if(you!==bot) res='You lose';
    await printOutput([{t:'out',s:`You: ${you}`},{t:'out',s:`Bot: ${bot}`}]);
    if(res.toLowerCase().includes('win')) await printOutput([{t:'success',s:res}]);
    else if(res.toLowerCase().includes('lose')) await printOutput([{t:'error',s:res}]);
    else await printOutput([{t:'info',s:res}]);
  }

  async function cmd_slots(){
    const reels=[1,2,3].map(()=>Math.floor(Math.random()*5));
    await printOutput([{t:'out',s:`| ${reels.join(' | ')} |`}]);
    if(reels.every(r=>r===reels[0])) await printOutput([{t:'success',s:'Jackpot! You win'}]); else await printOutput([{t:'out',s:'Try again!'}]);
  }

  async function cmd_blackjack(){
    const draw=()=>Math.floor(Math.random()*11)+1;
    const player=draw()+draw();
    const dealer=draw()+draw();
    await printOutput([{t:'out',s:`You: ${player}`},{t:'out',s:`Dealer: ${dealer}`}]);
    if(player>21) await printOutput([{t:'error',s:'Bust! You lose.'}]);
    else if(player>dealer) await printOutput([{t:'success',s:'You win'}]);
    else if(player===dealer) await printOutput([{t:'info',s:'Push (draw).'}]);
    else await printOutput([{t:'error',s:'You lose.'}]);
  }

  async function cmd_mine(){
    const size=5;
    const cells=size*size;
    const idx=Math.floor(Math.random()*cells);
    const grid=Array(cells).fill('·');
    grid[idx]='X';
    let out='';
    for(let r=0;r<size;r++){ out+=grid.slice(r*size,(r+1)*size).join(' ')+'\\n'; }
    await printOutput([{t:'out',s:out.trim()}]);
  }

  // -----------------------
  // THEMES package (themes only change accent/accent2/cmd-color/rim)
  // -----------------------
  const themePresets = {
    default: {},
    gold: {'--accent':'#FFD700','--accent2':'#FFECB3','--rim':'#FFD70022','--cmd-color':'#FFD700'},
    neon: {'--accent':'#D633FF','--accent2':'#8A2BE2','--rim':'#D633FF22','--cmd-color':'#D633FF'},
    sunset: {'--accent':'#FF6B35','--accent2':'#FF9A76','--rim':'#FF6B3522','--cmd-color':'#FF6B35'},
    matrix: {'--accent':'#00FF41','--accent2':'#2aff6f','--rim':'#00FF4122','--cmd-color':'#00FF41'},
    frost: {'--accent':'#A7E8F0','--accent2':'#DDF7FB','--rim':'#A7E8F022','--cmd-color':'#A7E8F0'},
    ocean: {'--accent':'#00A8E8','--accent2':'#7FD6FF','--rim':'#00A8E822','--cmd-color':'#00A8E8'},
    cyberpunk: {'--accent':'#FF2D95','--accent2':'#FFAA1D','--rim':'#FF2D9522','--cmd-color':'#FF2D95'}
  };

  function applyThemeVars(obj){
    // only set the keys provided (accent,accent2,cmd-color,rim)
    for(const k of Object.keys(obj)){
      document.documentElement.style.setProperty(k, obj[k]);
    }
  }
  async function cmd_theme_list(){
    // Render theme names colored by their cmd-color / accent, but DO NOT attach click handlers
    const keys = Object.keys(themePresets);
    for(const name of keys){
      const div = document.createElement('div');
      div.className = 'line out';
      const span = document.createElement('span');
      span.className = 'theme-name';
      const preset = themePresets[name] || {};
      let color = preset['--cmd-color'] || preset['--accent'] || '';
      if(!color){
        const s = getComputedStyle(document.documentElement).getPropertyValue('--cmd-color').trim();
        color = s || '';
      }
      if(color) span.style.color = color;
      span.textContent = name;
      // IMPORTANT: no click handler — theme change only via command 'theme-set <name>'
      div.appendChild(span);
      screen.appendChild(div);
    }
    screen.scrollTop = screen.scrollHeight;
  }
  async function cmd_theme_set(args){
    const name=(args[0]||'default').toLowerCase();
    if(name==='default'){ // reset
      await cmd_theme_reset();
      return;
    }
    if(!themePresets[name]) return printOutput([{t:'error',s:'Unknown theme'}]);
    applyThemeVars(themePresets[name]);
    await printOutput([{t:'success',s:`Theme set: ${name}`}]);
  }
  async function cmd_theme_edit(args){ const varName=args[0], val=args[1]; if(!varName||!val) return printOutput([{t:'error',s:'Usage: theme-edit <--var> <value>'}]); document.documentElement.style.setProperty(varName, val); await printOutput([{t:'success',s:`Set ${varName} = ${val}`}]); }
  async function cmd_theme_save(args){ const name=(args[0]||'custom'); const vars={}; const s=getComputedStyle(document.documentElement); const keys=['--accent','--accent2','--cmd-color','--rim']; keys.forEach(k=>{ vars[k]=s.getPropertyValue(k).trim(); }); localStorage.setItem('xterm_theme_'+name, JSON.stringify(vars)); await printOutput([{t:'success',s:`Theme saved: ${name}`}]); }
  async function cmd_theme_load(args){ const name=(args[0]||'custom'); const raw=localStorage.getItem('xterm_theme_'+name); if(!raw) return printOutput([{t:'error',s:'Theme not found'}]); const obj=JSON.parse(raw); applyThemeVars(obj); await printOutput([{t:'success',s:`Theme loaded: ${name}`}]); }
  async function cmd_theme_reset(){
    // remove only the theme-related variables (accent/accent2/cmd-color/rim) to return to defaults for current light/dark mode
    document.documentElement.style.removeProperty('--accent');
    document.documentElement.style.removeProperty('--accent2');
    document.documentElement.style.removeProperty('--cmd-color');
    document.documentElement.style.removeProperty('--rim');
    await printOutput([{t:'success',s:'Theme reset to default'}]);
  }

  // -----------------------
  // sysedit
  // -----------------------
  async function cmd_sysedit(args){
    const sub=(args[0]||'help').toLowerCase();
    if(sub==='help'){
      await printOutput([{t:'out',s:'sysedit show'},{t:'out',s:'sysedit theme <dark|light>'},{t:'out',s:'sysedit set-color <var> <value>'},{t:'out',s:'sysedit speed <n>'},{t:'out',s:'sysedit fontsize <px>'}]);
      return;
    }
    if(sub==='show'){ await printOutput([{t:'out',s:`typingSpeed: ${state.typingSpeed}`}]); const mono=getComputedStyle(document.documentElement).getPropertyValue('--mono-size').trim(); await printOutput([{t:'out',s:`--mono-size: ${mono||'unset'}`}]); await printOutput([{t:'out',s:`theme: ${document.documentElement.classList.contains('dark')?'dark':'light'}`}]); return; }
    if(sub==='theme'){ const mode=(args[1]||'').toLowerCase(); if(mode==='dark'||mode==='light'){ document.documentElement.classList.toggle('dark', mode==='dark'); document.documentElement.classList.toggle('light', mode==='light'); return printOutput([{t:'success',s:`Theme set to ${mode}`}]); } else return printOutput([{t:'error',s:'Usage: sysedit theme <dark|light>'}]); }
    if(sub==='set-color'){ const varName=args[1], val=args[2]; if(!varName||!val) return printOutput([{t:'error',s:'Usage: sysedit set-color <var> <value>'}]); document.documentElement.style.setProperty(varName, val); return printOutput([{t:'success',s:`Set ${varName} = ${val}`}]); }
    if(sub==='speed'){ const n=parseInt(args[1],10); if(isNaN(n)||n<15) return printOutput([{t:'error',s:'Usage: sysedit speed <n> (n>=15)'}]); state.typingSpeed=n; localStorage.setItem('xterminal-typingSpeed', String(state.typingSpeed)); return printOutput([{t:'success',s:`Typing speed set to ${state.typingSpeed}`}]); }
    if(sub==='fontsize'){ const px=parseInt(args[1],10); if(isNaN(px)||px<8) return printOutput([{t:'error',s:'Usage: sysedit fontsize <px>'}]); document.documentElement.style.setProperty('--mono-size', px+'px'); document.documentElement.style.setProperty('--mobile-mono-size', Math.max(8, px-1)+'px'); return printOutput([{t:'success',s:`Font size set to ${px}px`}]); }
    await printOutput([{t:'error',s:'Unknown sysedit subcommand'}]);
  }

  // -----------------------
  // registry & bindings
  // -----------------------
  const commandRegistry = {
    help:{fn:cmd_help,pkg:'system'}, clear:{fn:cmd_clear,pkg:'system'}, theme:{fn:cmd_theme,pkg:'system'}, info:{fn:cmd_info,pkg:'system'},
    packages:{fn:cmd_packages,pkg:'system'}, install:{fn:cmd_install,pkg:'system'}, uninstall:{fn:cmd_uninstall,pkg:'system'},
    date:{fn:cmd_date,pkg:'time'}, time:{fn:cmd_time,pkg:'time'}, timer:{fn:cmd_timer,pkg:'time'}, stopwatch:{fn:cmd_stopwatch,pkg:'time'},
    calc:{fn:cmd_calc,pkg:'calculator'}, unit:{fn:cmd_unit,pkg:'calculator'},
    password:{fn:cmd_password,pkg:'utilities'}, uuid:{fn:cmd_uuid,pkg:'utilities'}, binary:{fn:cmd_binary,pkg:'utilities'}, roll:{fn:cmd_roll,pkg:'utilities'},
    echo:{fn:cmd_echo,pkg:'text'}, alias:{fn:cmd_alias,pkg:'text'}, notes:{fn:cmd_notes,pkg:'text'}, sysedit:{fn:cmd_sysedit,pkg:'settings'},
    device:{fn:cmd_device,pkg:'device'}, ping:{fn:cmd_ping,pkg:'network'}, ifconfig:{fn:cmd_ifconfig,pkg:'network'}, netstat:{fn:cmd_netstat,pkg:'network'}, speedtest:{fn:cmd_speedtest,pkg:'network'},
    rps:{fn:cmd_rps,pkg:'games'}, slots:{fn:cmd_slots,pkg:'games'}, blackjack:{fn:cmd_blackjack,pkg:'games'}, mine:{fn:cmd_mine,pkg:'games'},
    'theme-list':{fn:cmd_theme_list,pkg:'themes'}, 'theme-set':{fn:cmd_theme_set,pkg:'themes'}, 'theme-edit':{fn:cmd_theme_edit,pkg:'themes'}, 'theme-save':{fn:cmd_theme_save,pkg:'themes'}, 'theme-load':{fn:cmd_theme_load,pkg:'themes'}, 'theme-reset':{fn:cmd_theme_reset,pkg:'themes'}
  };

  input.addEventListener('keydown',(e)=>{
    if(e.key==='Enter'){
      const raw=input.value.trim();
      if(!raw) return;
      printPromptLine(raw);
      state.history.push(raw);
      state.histIdx=state.history.length;
      const [cmdRaw,...args]=raw.split(/\s+/);
      const cmdLower=cmdRaw.toLowerCase();
      let actualCommand=cmdLower; let actualArgs=args.slice();
      if(state.aliases.has(cmdLower)){
        const ali=state.aliases.get(cmdLower);
        const parts=ali.split(/\s+/);
        actualCommand=parts[0];
        actualArgs=[...parts.slice(1),...args];
      }
      const entry=commandRegistry[actualCommand];
      if(!entry) printOutput([{t:'error',s:'Command not found'}]);
      else {
        const pkg=entry.pkg||'system';
        if(pkg!=='system' && !state.packages[pkg]) printOutput([{t:'error',s:'Command not found'}]);
        else entry.fn(actualArgs).catch(err=>{ printOutput([{t:'error',s:'Command error: '+(err&&err.message?err.message:String(err))}]); });
      }
      input.value='';
      renderChips();
    } else if(e.key==='ArrowUp'){
      if(state.histIdx>0){ state.histIdx--; input.value=state.history[state.histIdx]||''; }
      e.preventDefault();
    } else if(e.key==='ArrowDown'){
      if(state.histIdx<state.history.length){ state.histIdx++; input.value=state.history[state.histIdx]||''; }
      e.preventDefault();
    } else if(e.key==='Tab'){
      e.preventDefault();
      const val=input.value.trim(); if(!val) return;
      const allCommands=Object.keys(commandRegistry).filter(k=>{ const pkg=commandRegistry[k].pkg||'system'; if(pkg==='system') return true; return !!state.packages[pkg]; });
      const aliasCommands=Array.from(state.aliases.keys());
      const availableCommands=[...allCommands,...aliasCommands];
      const match=availableCommands.find(k=>k.startsWith(val.toLowerCase()));
      if(match) input.value=match+' ';
    }
  });

  function getSuggestions(){
    const base=['help','packages','install time','install calculator','install utilities','install text','install settings','theme dark','info'];
    if(state.packages.time) base.push('date','time tehran','timer 10','stopwatch start');
    if(state.packages.calculator) base.push('calc 2+2','unit 10 km mile');
    if(state.packages.utilities) base.push('password 16','uuid','roll 2d6');
    if(state.packages.text) base.push('echo Hello World','alias ll ls -la','notes add Important');
    if(state.packages.settings) base.push('sysedit show','sysedit speed 20','sysedit fontsize 12');
    if(state.packages.device) base.push('device');
    if(state.packages.network) base.push('ping 8.8.8.8','ifconfig','speedtest');
    if(state.packages.games) base.push('rps rock','blackjack','slots');
    if(state.packages.themes) base.push('theme-list','theme-set gold');
    return base;
  }

  function pickFour(arr){
    const pool=[...arr];
    const out=[];
    for(let i=0;i<4&&pool.length;i++){ const idx=Math.floor(Math.random()*pool.length); out.push(pool.splice(idx,1)[0]); }
    return out;
  }

  function renderChips(){
    chipsEl.innerHTML='';
    pickFour(getSuggestions()).forEach(txt=>{
      const c=document.createElement('div');
      c.className='chip';
      c.textContent=txt;
      c.addEventListener('click',()=>{ input.value=txt; input.focus(); });
      chipsEl.appendChild(c);
    });
  }

  // initial
  renderChips();
  input.focus();

  // new launch sequence with version 0.6
  (async () => {
    await printOutput([{t:'welcome',s:'Launching XTerminal...'}]);
    await printOutput([{t:'welcome',s:'Beta 0.6'}]);
    await printOutput([{t:'welcome',s:'System ready. Type "help" for available commands.'}]);
  })();

  // expose for debugging
  window._xterminal = { state, availablePackages, commandRegistry };
})();
</script>
</body>
</html>